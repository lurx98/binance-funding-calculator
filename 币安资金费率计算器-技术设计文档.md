# 币安资金费率计算器 - Web应用技术设计文档

## 1. 项目概述

### 1.1 项目目标

基于 React + Next.js 的现代化 Web 应用，提供直观的用户界面和数据持久化功能。

### 1.2 核心功能

- 资金费率历史数据查询与计算
- 支持按持仓数量或投入金额计算收益
- 多维度统计展示（日/月/年）
- 数据缓存到 PostgreSQL 数据库
- 历史查询记录管理

---

## 2. 技术栈选型

### 2.1 前端技术栈

- **框架**: Next.js 14+ (App Router)
- **UI 库**: React 18+
- **样式方案**: Tailwind CSS + shadcn/ui 组件库
- **状态管理**: React Hooks (useState, useReducer)
- **数据请求**: SWR 或 TanStack Query (React Query)
- **图表库**: Recharts 或 Chart.js
- **表单验证**: Zod + React Hook Form
- **日期处理**: date-fns

### 2.2 后端技术栈

- **运行时**: Next.js API Routes (Server Actions)
- **数据库**: PostgreSQL 15+
- **ORM**: Prisma
- **API 客户端**: Axios 或 Fetch API

### 2.3 部署方案

- **托管平台**: Vercel
- **数据库**: 自己的服务器

---

## 3. 数据接口设计

### 3.1 币安资金费率历史数据接口

#### 3.1.1 接口信息

- **接口地址**: `https://www.binance.com/bapi/futures/v1/public/future/common/get-funding-rate-history`
- **请求方法**: POST
- **Content-Type**: application/json

#### 3.1.2 请求参数

```json
{
  "symbol": "XAGUSDT",
  "page": 1,
  "rows": 20
}
```

| 参数名 | 类型   | 必填 | 说明                                     |
| ------ | ------ | ---- | ---------------------------------------- |
| symbol | string | 是   | 交易对符号，如 BTCUSDT、ETHUSDT、XAGUSDT |
| page   | number | 是   | 页码，从 1 开始                          |
| rows   | number | 是   | 每页返回的数据条数，建议 20-100          |

#### 3.1.3 响应数据

```json
{
  "data": [
    {
      "calcTime": 1769025600001,
      "symbol": "XAGUSDT",
      "fundingIntervalHours": 4,
      "lastFundingRate": "0.00011847",
      "markPrice": "91.39904204"
    }
  ],
  "success": true,
  "total": 108
}
```

| 字段名  | 类型    | 说明                 |
| ------- | ------- | -------------------- |
| success | boolean | 请求是否成功         |
| total   | number  | 总数据条数           |
| data    | array   | 资金费率历史数据数组 |

**data 数组元素字段说明：**

| 字段名               | 类型   | 说明                                                             |
| -------------------- | ------ | ---------------------------------------------------------------- |
| calcTime             | number | 结算时间戳（毫秒）                                               |
| symbol               | string | 交易对符号                                                       |
| fundingIntervalHours | number | 资金费率结算间隔（小时），通常为 4 或 8                          |
| lastFundingRate      | string | 资金费率（小数形式），正数表示多头支付空头，负数表示空头支付多头 |
| markPrice            | string | 标记价格（USDT）                                                 |

#### 3.1.4 数据获取策略

1. **分页获取**: 由于接口支持分页，需要循环请求直到获取所有数据
2. **请求频率控制**: 建议每次请求间隔 200-500ms，避免触发限流
3. **数据缓存**: 将获取的数据存储到 PostgreSQL，避免重复请求
4. **增量更新**: 定期检查最新数据，只获取新增的资金费率记录

#### 3.1.5 错误处理

- **网络错误**: 实现重试机制（最多 3 次）
- **限流错误**: 增加请求间隔时间
- **数据异常**: 记录日志并跳过异常数据

---

## 4. 页面布局设计

### 4.1 整体布局结构

```
┌─────────────────────────────────────────────────────────────┐
│                        顶部导航栏                            │
│  Logo | 资金费率计算器 | 历史记录 | 关于                      │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                      输入参数区域                            │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐        │
│  │ 交易对   │ │ 输入方式 │ │ 持仓/金额│ │ 起始日期 │ [计算]    │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘        │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                      汇总信息卡片                            │
│  总收益: +1234.56 USDT | 数据条数: 1000 | 统计周期: 365天     │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                      统计结果展示区                           │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                    日统计 (占50%高度)                  │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │  日期  │  收益(USDT)  │  结算次数  │  首条价格   │    │  │
│  │  ├─────────────────────────────────────────────────┤   │  │
│  │  │ 2024-01-25 │ +12.3456 │    3     │  32.1234     │  │  │
│  │  │ 2024-01-24 │ -5.6789  │    3     │  31.9876     │  │  │
│  │  └─────────────────────────────────────────────────┘  │  │
│  │  [折线图: 每日收益趋势]                                 │  │
│  └───────────────────────────────────────────────────────┘  │
│  ┌─────────────────────────┐ ┌─────────────────────────┐    │
│  │   月统计 (占25%高度)     │ │   年统计 (占25%高度)     │    │
│  │  ┌───────────────────┐  │ │  ┌───────────────────┐  │    │
│  │  │ 2024年01月        │  │ │  │ 2024年            │  │    │
│  │  │ +123.45 USDT     │  │ │  │ +1234.56 USDT     │  │  │
│  │  │ (90次结算)        │  │ │  │ (1080次结算)       │  │  │
│  │  └───────────────────┘  │ │  └───────────────────┘  │  │
│  │  [柱状图]                │ │  [柱状图]                │  │
│  └─────────────────────────┘ └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘

```

### 4.2 输入参数区域详细设计

#### 4.2.1 交易对选择

- **组件类型**: Select 下拉选择框
- **常用交易对**: BTCUSDT, ETHUSDT, BNBUSDT, SOLUSDT, XRPUSDT, ADAUSDT, DOGEUSDT, XAGUSDT
- **支持搜索**: 用户可输入交易对名称快速筛选
- **验证规则**: 必填项，需验证交易对是否存在

#### 4.2.2 输入方式切换

- **组件类型**: Radio Group 单选按钮组
- **选项**:
  - 持仓数量（默认）
  - 投入金额
- **说明文字**:
  - 持仓数量: 输入持有的币种数量
  - 投入金额: 输入投入的 USDT 金额

#### 4.2.3 数值输入

- **组件类型**: Number Input 数字输入框
- **验证规则**:
  - 必填项
  - 必须大于 0
  - 最多 8 位小数
- **占位符**:
  - 持仓数量模式: "请输入持仓数量"
  - 投入金额模式: "请输入投入金额 (USDT)"

#### 4.2.4 起始日期选择

- **组件类型**: Date Picker 日期选择器
- **默认值**: 当前日期往前推 30 天
- **限制**: 不能选择未来日期
- **快捷选项**: 最近 7 天、最近 30 天、最近 90 天、最近 365 天

#### 4.2.5 计算按钮

- **组件类型**: Button 主要按钮
- **状态**:
  - 默认: 可点击
  - 加载中: 显示 Loading 动画，禁用点击
  - 禁用: 表单验证未通过时禁用
- **点击事件**: 触发数据获取和计算流程

---

## 5. 数据库设计

### 5.1 数据表结构

#### 5.1.1 资金费率历史表 (funding_rate_history)

```sql
CREATE TABLE funding_rate_history (
  id SERIAL PRIMARY KEY,
  symbol VARCHAR(20) NOT NULL,
  calc_time BIGINT NOT NULL,
  funding_interval_hours INTEGER NOT NULL,
  last_funding_rate DECIMAL(18, 8) NOT NULL,
  mark_price DECIMAL(18, 8) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(symbol, calc_time)
);

-- 创建索引提升查询性能
CREATE INDEX idx_symbol_calc_time ON funding_rate_history(symbol, calc_time DESC);
CREATE INDEX idx_calc_time ON funding_rate_history(calc_time DESC);
```

**字段说明：**

| 字段名                 | 类型           | 说明                     |
| ---------------------- | -------------- | ------------------------ |
| id                     | SERIAL         | 主键，自增 ID            |
| symbol                 | VARCHAR(20)    | 交易对符号               |
| calc_time              | BIGINT         | 结算时间戳（毫秒）       |
| funding_interval_hours | INTEGER        | 资金费率结算间隔（小时） |
| last_funding_rate      | DECIMAL(18, 8) | 资金费率                 |
| mark_price             | DECIMAL(18, 8) | 标记价格                 |
| created_at             | TIMESTAMP      | 数据创建时间             |

#### 5.1.2 查询历史记录表 (query_history)

```sql
CREATE TABLE query_history (
  id SERIAL PRIMARY KEY,
  symbol VARCHAR(20) NOT NULL,
  input_type VARCHAR(10) NOT NULL, -- 'quantity' 或 'amount'
  input_value DECIMAL(18, 8) NOT NULL,
  start_date DATE NOT NULL,
  total_profit DECIMAL(18, 8),
  total_records INTEGER,
  query_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建索引
CREATE INDEX idx_query_time ON query_history(query_time DESC);
CREATE INDEX idx_symbol ON query_history(symbol);
```

**字段说明：**

| 字段名        | 类型           | 说明                                                |
| ------------- | -------------- | --------------------------------------------------- |
| id            | SERIAL         | 主键，自增 ID                                       |
| symbol        | VARCHAR(20)    | 查询的交易对                                        |
| input_type    | VARCHAR(10)    | 输入类型：quantity（持仓数量）或 amount（投入金额） |
| input_value   | DECIMAL(18, 8) | 输入的数值                                          |
| start_date    | DATE           | 查询的起始日期                                      |
| total_profit  | DECIMAL(18, 8) | 总收益（USDT）                                      |
| total_records | INTEGER        | 数据条数                                            |
| query_time    | TIMESTAMP      | 查询时间                                            |

### 5.2 Prisma Schema 定义

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model FundingRateHistory {
  id                    Int      @id @default(autoincrement())
  symbol                String   @db.VarChar(20)
  calcTime              BigInt   @map("calc_time")
  fundingIntervalHours  Int      @map("funding_interval_hours")
  lastFundingRate       Decimal  @map("last_funding_rate") @db.Decimal(18, 8)
  markPrice             Decimal  @map("mark_price") @db.Decimal(18, 8)
  createdAt             DateTime @default(now()) @map("created_at")

  @@unique([symbol, calcTime])
  @@index([symbol, calcTime(sort: Desc)])
  @@index([calcTime(sort: Desc)])
  @@map("funding_rate_history")
}

model QueryHistory {
  id           Int      @id @default(autoincrement())
  symbol       String   @db.VarChar(20)
  inputType    String   @map("input_type") @db.VarChar(10)
  inputValue   Decimal  @map("input_value") @db.Decimal(18, 8)
  startDate    DateTime @map("start_date") @db.Date
  totalProfit  Decimal? @map("total_profit") @db.Decimal(18, 8)
  totalRecords Int?     @map("total_records")
  queryTime    DateTime @default(now()) @map("query_time")

  @@index([queryTime(sort: Desc)])
  @@index([symbol])
  @@map("query_history")
}
```

---

## 6. 核心业务逻辑

### 6.1 资金费率收益计算公式

#### 6.1.1 按持仓数量计算

```
单次收益 = 持仓数量 × 标记价格 × 资金费率
```

**示例：**

- 持仓数量: 100 个币
- 标记价格: 50,000 USDT
- 资金费率: 0.0001 (0.01%)

```
单次收益 = 100 × 50,000 × 0.0001 = 500 USDT
```

#### 6.1.2 按投入金额计算

```
持仓数量 = 投入金额 ÷ 首条数据的标记价格
单次收益 = 持仓数量 × 标记价格 × 资金费率
```

**示例：**

- 投入金额: 10,000 USDT
- 首条标记价格: 50,000 USDT
- 持仓数量 = 10,000 ÷ 50,000 = 0.2 个币

```
单次收益 = 0.2 × 50,000 × 0.0001 = 1 USDT
```

### 6.2 数据聚合逻辑

#### 6.2.1 日统计

```typescript
interface DailyStats {
  date: string // 日期 (YYYY-MM-DD)
  profit: number // 当日总收益 (USDT)
  count: number // 结算次数
  firstPrice: number // 当日首条数据的标记价格
  avgFundingRate: number // 平均资金费率
}
```

**计算逻辑：**

1. 按日期分组所有资金费率数据
2. 计算每条数据的收益并累加
3. 统计当日结算次数
4. 记录当日首条数据的标记价格

#### 6.2.2 月统计

```typescript
interface MonthlyStats {
  month: string // 月份 (YYYY-MM)
  profit: number // 当月总收益 (USDT)
  count: number // 结算次数
  avgDailyProfit: number // 日均收益
}
```

#### 6.2.3 年统计

```typescript
interface YearlyStats {
  year: string // 年份 (YYYY)
  profit: number // 当年总收益 (USDT)
  count: number // 结算次数
  avgMonthlyProfit: number // 月均收益
}
```

### 6.3 数据获取流程

```typescript
async function fetchFundingRateData(symbol: string, startDate: Date) {
  let page = 1
  let allData = []
  let hasMore = true

  while (hasMore) {
    // 1. 请求币安接口
    const response = await fetch(
      'https://www.binance.com/bapi/futures/v1/public/future/common/get-funding-rate-history',
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ symbol, page, rows: 100 })
      }
    )

    const result = await response.json()

    if (!result.success || !result.data.length) {
      hasMore = false
      break
    }

    // 2. 过滤起始日期之后的数据
    const filteredData = result.data.filter(item => {
      const itemDate = new Date(item.calcTime)
      return itemDate >= startDate
    })

    allData.push(...filteredData)

    // 3. 判断是否需要继续获取
    if (filteredData.length < result.data.length) {
      hasMore = false // 已经获取到起始日期之前的数据
    } else if (page * 100 >= result.total) {
      hasMore = false // 已经获取所有数据
    } else {
      page++
      await sleep(300) // 延迟 300ms 避免限流
    }
  }

  // 4. 保存到数据库
  await saveFundingRateData(allData)

  return allData
}
```

---

## 7. API 路由设计

### 7.1 获取资金费率数据

**路由**: `POST /api/funding-rate/fetch`

**请求体：**

```typescript
{
  symbol: string;      // 交易对
  startDate: string;   // 起始日期 (YYYY-MM-DD)
  forceRefresh?: boolean; // 是否强制刷新（忽略缓存）
}
```

**响应：**

```typescript
{
  success: boolean;
  data: FundingRateHistory[];
  total: number;
  cached: boolean; // 是否来自缓存
}
```

### 7.2 计算收益统计

**路由**: `POST /api/funding-rate/calculate`

**请求体：**

```typescript
{
  symbol: string
  inputType: 'quantity' | 'amount'
  inputValue: number
  startDate: string
}
```

**响应：**

```typescript
{
  success: boolean;
  data: {
    daily: DailyStats[];
    monthly: MonthlyStats[];
    yearly: YearlyStats[];
    summary: {
      totalProfit: number;
      totalRecords: number;
      dayCount: number;
      avgDailyProfit: number;
    }
  }
}
```

### 7.3 获取查询历史

**路由**: `GET /api/query-history?limit=10&offset=0`

**响应：**

```typescript
{
  success: boolean;
  data: QueryHistory[];
  total: number;
}
```

### 7.4 获取支持的交易对列表

**路由**: `GET /api/symbols`

**响应：**

```typescript
{
  success: boolean;
  data: string[]; // ['BTCUSDT', 'ETHUSDT', ...]
}
```

---

## 8. 前端组件结构

### 8.1 页面组件层级

```
app/
├── page.tsx                    # 主页面
├── layout.tsx                  # 根布局
├── api/                        # API 路由
│   ├── funding-rate/
│   │   ├── fetch/route.ts
│   │   └── calculate/route.ts
│   ├── query-history/route.ts
│   └── symbols/route.ts
└── components/
    ├── Header.tsx              # 顶部导航栏
    ├── InputForm.tsx           # 输入参数表单
    ├── StatsDisplay.tsx        # 统计结果展示
    │   ├── DailyStats.tsx      # 日统计
    │   ├── MonthlyStats.tsx    # 月统计
    │   ├── YearlyStats.tsx     # 年统计
    │   └── Summary.tsx         # 汇总信息
    ├── HistoryModal.tsx        # 历史记录弹窗
    └── ui/                     # shadcn/ui 组件
        ├── button.tsx
        ├── input.tsx
        ├── select.tsx
        ├── date-picker.tsx
        └── ...
```

### 8.2 核心组件设计

#### 8.2.1 InputForm 组件

```typescript
interface InputFormProps {
  onSubmit: (data: FormData) => void
  loading: boolean
}

interface FormData {
  symbol: string
  inputType: 'quantity' | 'amount'
  inputValue: number
  startDate: Date
}
```

#### 8.2.2 StatsDisplay 组件

```typescript
interface StatsDisplayProps {
  data: {
    daily: DailyStats[]
    monthly: MonthlyStats[]
    yearly: YearlyStats[]
    summary: SummaryData
  } | null
  loading: boolean
}
```

---

## 9. 开发计划

### 9.1 第一阶段：基础框架搭建（1-2天）

- [ ] 初始化 Next.js 项目
- [ ] 配置 Tailwind CSS 和 shadcn/ui
- [ ] 设置 PostgreSQL 数据库连接
- [ ] 配置 Prisma ORM
- [ ] 创建数据库表结构

### 9.2 第二阶段：数据获取功能（2-3天）

- [ ] 实现币安 API 数据获取逻辑
- [ ] 实现数据缓存机制
- [ ] 实现分页获取和错误处理
- [ ] 创建 API 路由：`/api/funding-rate/fetch`

### 9.3 第三阶段：计算逻辑实现（2-3天）

- [ ] 实现收益计算公式
- [ ] 实现日/月/年统计聚合
- [ ] 创建 API 路由：`/api/funding-rate/calculate`
- [ ] 单元测试

### 9.4 第四阶段：前端界面开发（3-4天）

- [ ] 开发输入表单组件
- [ ] 开发统计展示组件
- [ ] 集成图表库（Recharts）
- [ ] 实现响应式布局
- [ ] 添加加载状态和错误提示

### 9.5 第五阶段：历史记录功能（1-2天）

- [ ] 实现查询历史保存
- [ ] 开发历史记录列表
- [ ] 实现历史记录快速加载

### 9.6 第六阶段：优化和部署（1-2天）

- [ ] 性能优化
- [ ] SEO 优化
- [ ] 部署到 Vercel
- [ ] 配置生产环境数据库

**预计总开发时间：10-16 天**

---

## 10. 注意事项

### 10.1 性能优化

1. **数据库查询优化**
   - 使用索引加速查询
   - 避免全表扫描
   - 使用连接池管理数据库连接

2. **前端性能优化**
   - 使用 React.memo 避免不必要的重渲染
   - 图表数据虚拟化（大数据量时）
   - 使用 SWR 缓存 API 响应

3. **API 请求优化**
   - 实现请求去重
   - 添加请求超时处理
   - 使用 CDN 加速静态资源

### 10.2 安全性考虑

1. **API 安全**
   - 实现请求频率限制
   - 验证输入参数
   - 防止 SQL 注入（使用 Prisma ORM）

2. **数据安全**
   - 敏感信息使用环境变量
   - 数据库连接加密
   - 定期备份数据

### 10.3 错误处理

1. **网络错误**
   - 实现重试机制
   - 显示友好的错误提示
   - 记录错误日志

2. **数据异常**
   - 验证 API 返回数据格式
   - 处理空数据情况
   - 异常数据过滤

---

## 11. 后续扩展功能

### 11.1 功能增强

- [ ] 支持多交易对对比
- [ ] 导出数据为 Excel/CSV
- [ ] 自定义日期范围选择
- [ ] 实时资金费率推送
- [ ] 收益预测功能

### 11.2 用户体验优化

- [ ] 添加深色模式
- [ ] 多语言支持（中文/英文）
- [ ] 移动端适配优化
- [ ] 添加使用教程

### 11.3 数据分析

- [ ] 资金费率趋势分析
- [ ] 最佳持仓时机推荐
- [ ] 收益率排行榜
- [ ] 历史数据对比

---

**文档版本**: v1.0  
**最后更新**: 2026-01-25  
**维护者**: 开发团队
